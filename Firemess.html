<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
        .status {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 70%;
        }
        .my-message {
            background: #1a73e8;
            color: white;
            margin-left: auto;
        }
        .other-message {
            background: #f1f3f4;
            color: black;
            margin-right: auto;
        }
        .system-message {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
        }
        button {
            padding: 12px 25px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { background: #1557b0; }
        .user-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .user-item {
            display: inline-block;
            background: #e3f2fd;
            padding: 5px 15px;
            margin: 3px;
            border-radius: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer">
        <h1>üí¨ –ú–æ–π —á–∞—Ç</h1>
        
        <div class="status" id="status">
            üî¥ –ù–µ –≤ —Å–µ—Ç–∏
        </div>

        <div class="user-list" id="userList">
            <strong>üë• –û–Ω–ª–∞–π–Ω:</strong> <span id="userCount">0</span>
            <div id="users" style="margin-top: 10px;"></div>
        </div>

        <div class="messages" id="messages">
            <div class="system-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!</div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
            <button id="sendButton" onclick="sendMessage()" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ò ===
        const CHAT_ID = 'my_chat_' + window.location.hostname; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —á–∞—Ç–∞
        const STORAGE_URL = 'https://api.jsonbin.io/v3/b'; // –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ JSON-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        
        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º ID —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        let binId = localStorage.getItem('binId');
        let apiKey = '$2a$10$32XqZQXzRqZQXzRqZQXzRu'; // –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞
        let username = localStorage.getItem('username') || '';
        let userId = localStorage.getItem('userId') || generateId();
        let messages = [];
        let users = {};

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
        function generateId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }

        // –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ
        if (!username) {
            username = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:');
            if (!username) username = '–ì–æ—Å—Ç—å_' + Math.floor(Math.random() * 1000);
            localStorage.setItem('username', username);
            localStorage.setItem('userId', userId);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function setStatus(online) {
            const status = document.getElementById('status');
            if (online) {
                status.innerHTML = 'üü¢ –í —Å–µ—Ç–∏';
                status.style.background = '#d4edda';
                status.style.color = '#155724';
            } else {
                status.innerHTML = 'üî¥ –ù–µ –≤ —Å–µ—Ç–∏';
                status.style.background = '#f8d7da';
                status.style.color = '#721c24';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addMessage(text, sender, isMyMessage = false) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
            
            const time = new Date().toLocaleTimeString().substr(0,5);
            
            if (sender === 'system') {
                div.className = 'system-message';
                div.textContent = text;
            } else {
                div.innerHTML = `
                    <strong>${sender}</strong><br>
                    ${text}<br>
                    <small style="opacity:0.7;">${time}</small>
                `;
            }
            
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ
            addMessage(text, username, true);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            saveMessage({
                text: text,
                sender: username,
                senderId: userId,
                time: Date.now()
            });
            
            input.value = '';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function saveMessage(msg) {
            messages.push(msg);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
            localStorage.setItem('messages_' + CHAT_ID, JSON.stringify(messages.slice(-50)));
            
            // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ
            fetch(`${STORAGE_URL}/${binId || ''}`, {
                method: binId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': apiKey
                },
                body: JSON.stringify({
                    messages: messages.slice(-50),
                    users: users
                })
            })
            .then(res => res.json())
            .then(data => {
                if (!binId && data.metadata?.id) {
                    binId = data.metadata.id;
                    localStorage.setItem('binId', binId);
                }
            })
            .catch(() => {
                // –ï—Å–ª–∏ –æ–±–ª–∞–∫–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ - —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                console.log('–†–∞–±–æ—Ç–∞–µ–º –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ');
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages() {
            // –°–Ω–∞—á–∞–ª–∞ –∏–∑ localStorage
            const saved = localStorage.getItem('messages_' + CHAT_ID);
            if (saved) {
                messages = JSON.parse(saved);
                messages.forEach(msg => {
                    addMessage(msg.text, msg.sender, msg.senderId === userId);
                });
            }
            
            // –ü–æ—Ç–æ–º –∏–∑ –æ–±–ª–∞–∫–∞
            if (binId) {
                fetch(`${STORAGE_URL}/${binId}/latest`, {
                    headers: { 'X-Master-Key': apiKey }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.record?.messages) {
                        messages = data.record.messages;
                        document.getElementById('messages').innerHTML = '';
                        messages.forEach(msg => {
                            addMessage(msg.text, msg.sender, msg.senderId === userId);
                        });
                    }
                })
                .catch(() => {});
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUserList() {
            const userDiv = document.getElementById('users');
            const countSpan = document.getElementById('userCount');
            
            users[userId] = {
                name: username,
                lastSeen: Date.now()
            };
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–ª—å—à–µ 30 —Å–µ–∫)
            const now = Date.now();
            Object.keys(users).forEach(id => {
                if (now - users[id].lastSeen > 30000) {
                    delete users[id];
                }
            });
            
            const onlineUsers = Object.values(users);
            countSpan.textContent = onlineUsers.length;
            
            userDiv.innerHTML = onlineUsers.map(u => 
                `<span class="user-item">${u.name}</span>`
            ).join('');
        }

        // Heartbeat - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –º—ã –æ–Ω–ª–∞–π–Ω
        function heartbeat() {
            users[userId] = {
                name: username,
                lastSeen: Date.now()
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('users_' + CHAT_ID, JSON.stringify(users));
            
            updateUserList();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            setStatus(true);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–≤–æ–¥
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const savedUsers = localStorage.getItem('users_' + CHAT_ID);
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º heartbeat
            heartbeat();
            setInterval(heartbeat, 10000);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            setInterval(() => {
                if (binId) {
                    fetch(`${STORAGE_URL}/${binId}/latest`, {
                        headers: { 'X-Master-Key': apiKey }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.record?.messages?.length > messages.length) {
                            // –ï—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                            const newMessages = data.record.messages.slice(messages.length);
                            newMessages.forEach(msg => {
                                if (!messages.find(m => m.time === msg.time)) {
                                    addMessage(msg.text, msg.sender, msg.senderId === userId);
                                }
                            });
                            messages = data.record.messages;
                        }
                    })
                    .catch(() => {});
                }
            }, 3000);
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>
